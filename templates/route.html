<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Route Air Safety</title>
    <link rel="stylesheet" href="/static/style.css">
    <style>
        body { background: #fff; color: #000; font-family: Arial, Helvetica, sans-serif; }
        .container { max-width: 1080px; margin: 24px auto; padding: 0 16px; }
        h1 { font-size: 22px; border-bottom: 2px solid #000; padding-bottom: 8px; }
        .meta { margin: 12px 0; padding: 12px; border: 1px solid #000; }
        #map { width: 100%; height: 520px; border: 1px solid #000; }
        .controls { margin-top: 12px; }
        a.button { display: inline-block; padding: 8px 12px; background: #000; color: #fff; text-decoration: none; border: 1px solid #000; }
    </style>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
</head>
<body>
    <div class="container">
        <h1>Route Air Safety</h1>
        <div class="meta">
            <div><strong>Origin:</strong> {{ origin_name }} ({{ origin.lat }}, {{ origin.lon }})</div>
            <div><strong>Destination:</strong> {{ dest_name }} ({{ dest.lat }}, {{ dest.lon }})</div>
            <div><strong>Gases:</strong> {{ ", ".join(gases) }}</div>
            <div><strong>Route status:</strong> {{ status_text }}</div>
        </div>
        <div id="map"></div>
        <div class="panel" style="margin-top:10px; border:1px solid #000; padding:8px;">
            <div><strong>Routes</strong></div>
            <div id="routes-list" class="small"></div>
        </div>
        <div class="controls">
            <a class="button" href="/">Back</a>
            {% if alt_available %}
            <a class="button" href="/route/alternate?origin={{ origin_name|urlencode }}&destination={{ dest_name|urlencode }}&gases={{ ",".join(gases)|urlencode }}&grid_step_km={{ grid_step_km }}">Find Alternate Route</a>
            {% endif %}
        </div>
    </div>

    <script>
        const origin = [{{ origin.lat }}, {{ origin.lon }}];
        const dest = [{{ dest.lat }}, {{ dest.lon }}];
        const gases = '{{ ",".join(gases) }}';
        const gridStep = {{ grid_step_km }};

        const map = L.map('map').setView(origin, 6);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 18, attribution: '&copy; OpenStreetMap contributors'
        }).addTo(map);

        const baseStyle = { color: '#000', weight: 3, opacity: 0.85 };
        const dangerStyle = { color: '#E74C3C', weight: 5, opacity: 0.95 };
        const safeStyle = { color: '#2ECC71', weight: 5, opacity: 0.95 };

        function severityToColor(sev) {
            // 0..4 -> green, yellow, orange, red, purple
            switch (sev) {
                case 0: return '#2ECC71';
                case 1: return '#F1C40F';
                case 2: return '#E67E22';
                case 3: return '#E74C3C';
                case 4: return '#8E44AD';
                default: return '#95A5A6';
            }
        }

        const originMarker = L.marker(origin).addTo(map).bindPopup('Origin');
        const destMarker = L.marker(dest).addTo(map).bindPopup('Destination');

        {% if routes %}
        const routes = {{ routes|safe }};
        let boundsPoints = [origin, dest];
        routes.forEach(r => {
            // Draw as colored segments by severity
            const coords = r.coords || [];
            const sev = r.severity || [];
            const segs = [];
            for (let i = 1; i < coords.length; i++) {
                const a = coords[i-1];
                const b = coords[i];
                const s = Math.max(0, Math.min(4, (sev[i-1] || 0)));
                const color = severityToColor(s);
                const weight = r.safest ? 6 : 4;
                const seg = L.polyline([a, b], { color, weight, opacity: 0.95 }).addTo(map);
                segs.push(seg);
            }
            const total = (r.distance_km ? `${r.distance_km.toFixed(1)} km` : 'N/A');
            const label = `${r.name}${r.safest ? ' (safest)' : ''}<br>Exposure score: ${r.score.toFixed(0)}<br>Distance: ${total}`;
            if (segs.length) segs[0].bindPopup(label);

            boundsPoints = boundsPoints.concat(coords);
            // Append to list
            const row = document.createElement('div');
            row.textContent = `${r.name}${r.safest ? ' (safest)' : ''} — Score: ${r.score.toFixed(0)} — Distance: ${total}${r.blocked ? ' — near high pollution' : ''}`;
            document.getElementById('routes-list').appendChild(row);
        });
        {% endif %}

        {% if routes %}
        map.fitBounds(L.latLngBounds(boundsPoints));
        {% else %}
        map.fitBounds(L.latLngBounds([origin, dest]));
        {% endif %}

        {% if hotspots_geojson %}
        const hs = {{ hotspots_geojson|safe }};
        const colorMapHS = { 'moderate': '#F1C40F', 'unhealthy': '#E67E22', 'very_unhealthy': '#E74C3C', 'hazardous': '#8E44AD' };
        (hs.features || []).forEach(f => {
            if (!f || !f.geometry || f.geometry.type !== 'Point') return;
            const p = f.properties || {};
            const color = colorMapHS[p.level] || '#F1C40F';
            const lat = f.geometry.coordinates[1];
            const lon = f.geometry.coordinates[0];
            const rMeters = (p.radius_km || 5) * 1000;
            L.circle([lat, lon], { radius: rMeters, color: color, fillColor: color, fillOpacity: 0.25, weight: 1 })
              .addTo(map)
              .bindPopup(`${p.gas} hotspot (${p.level})${p.place ? '<br><em>' + p.place + '</em>' : ''}`);
        });
        {% endif %}

        
    </script>
</body>
</html>



